#!/bin/bash
set -e

if ! test -e .travis.yml
then
    echo Run this script from the SCZ-deploy root dir
    exit 2
fi

# activate correct python virtualenv
source $HOME/virtualenv/python3.6/bin/activate

echo '===================================================='
echo '== Running Syntax Check'
echo '===================================================='
echo Checking jinja2 files
find . -name '*.j2'  -print0 | xargs -0 python ./scripts/syntax-yml -q
echo Checking yaml files
find . -name '*.yml' -print0 | xargs -0 python ./scripts/syntax-jinja -q
echo Running yamllint
yamllint .
echo


echo '===================================================='
echo '== Starting deploy (run 1)'
echo '===================================================='
./start-vm --provider docker
echo

# run second time, to check if reeantrace works ok
echo '===================================================='
echo '== Starting deploy (run 2)'
echo '===================================================='
export REEANTRANT=1
./start-vm
echo

# check if the second run didn't give (too many) "changed"-states
echo '===================================================='
echo '== Running idempotency check...'
echo '===================================================='
python ./scripts/check-idempotency-status

exit 0

