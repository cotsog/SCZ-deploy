<VirtualHost *:443>
        ServerName {{ nextcloud_hostname }}

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/html

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined

        SSLEngine on
        SSLCertificateFile    /etc/letsencrypt/live/{{nextcloud_hostname}}/fullchain.pem
        SSLCertificateKeyFile /etc/letsencrypt/live/{{nextcloud_hostname}}/privkey.pem

        <Location "/">
            AuthType "Mellon"
            Require all granted
            MellonEnable "info"
            MellonVariable "cookie"
            MellonCookiePath /
            MellonMergeEnvVars On ";"

            MellonSPPrivateKeyFile {{ mellon_dir }}/sp.key
            MellonSPCertFile {{ mellon_dir }}/sp.crt

            MellonIdPMetadataFile {{ mellon_dir }}/proxy_idp.xml

            RequestHeader set MELLON_uid %{MELLON_urn:mace:dir:attribute-def:uid}e
            RequestHeader set MELLON_isMemberOf %{MELLON_urn:mace:dir:attribute-def:isMemberOf}e
        </Location>

        <Location "/login">
            Require valid-user
            MellonEnable "auth"
        </Location>

        #ProxyVia On
        #ProxyPreserveHost On
        #RequestHeader set X-Forwarded-Proto 'https' env=HTTPS
        ProxyRequests Off
        ProxyPass / http://localhost:{{ docker_ports.nextcloud }}/
        ProxyPassReverse / http://localhost:{{ docker_ports.nextcloud }}/
</VirtualHost>
